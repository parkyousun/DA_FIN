---
title: "Kakao_API"
author: "성원호"
date: "6/22/2021"
output: html_document
---

```{r setup, include=FALSE}
# usethis::edit_r_environ()
library(httr)
library(tidyverse)
library(leaflet)
library(jsonlite)
library(glue)
library(dplyr)
apt <- read.csv("APT2021.csv", fileEncoding = "EUC-KR", encoding = "UTF-8")
apt

a <- sample_frac(apt, 0.01)
a

res <- GET(url = 'https://dapi.kakao.com/v2/local/search/address.json',
           query = list(query = '서울특별시 종로구 사직로 161'),
           add_headers(Authorization = Sys.getenv('KAKAO_MAP_API_KEY')))
print(x = res)
coord$message

df <- a %>%
  mutate(지번주소 =str_c(dong, bungi, sep=' '))%>%
  select(aptnm, 지번주소) %>%
  group_by(aptnm, 지번주소)

df$위도 <- NA
df$경도 <- NA

df

for (i in 1:nrow(x = df)){
  cat('현재', i, '번째 주소의 위경도 좌표를 얻는 중입니다!\n')
  res <- GET(url = 'https://dapi.kakao.com/v2/local/search/address.json',
             query = list(query = df$지번주소[i]),
             add_headers(Authorization = Sys.getenv('KAKAO_MAP_API_KEY')))
  
  tryCatch({
  coord <- res %>% content(as = 'text') %>% fromJSON()
  
   df$위도[i] <- coord$documents$y
   df$경도[i] <- coord$documents$x
   
     Sys.sleep(time = 1)
  }, error = function(e) cat('--> 에러가 발생하여 건너 뜁니다.\n'))
}

is.na(x = df$위도) %>% sum()

df <- dplyr::filter(.data= df, is.na(x= 위도) == FALSE)

write.csv(df, "위도,경도 테스트.csv")
```
